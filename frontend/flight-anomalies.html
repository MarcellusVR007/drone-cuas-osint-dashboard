<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Anomalies - OSINT Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
    <style>
        body {
            background: #0f0f0f;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .navbar {
            background: #1a1a1a;
            border-bottom: 2px solid #dc3545;
        }
        .stats-card {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        #map {
            height: 500px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .anomaly-card {
            background: #2d2d2d;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .risk-high { border-left-color: #dc3545; }
        .risk-medium { border-left-color: #ffc107; }
        .risk-low { border-left-color: #6c757d; }
        .badge-area-military { background: #dc3545; }
        .badge-area-nuclear { background: #ff6b6b; }
        .badge-area-airport { background: #0d6efd; }
        .filter-panel {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt text-danger"></i> OSINT CUAS Dashboard
            </a>
            <span class="text-light">Flight Anomaly Detection</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Filters -->
            <div class="col-md-12">
                <div class="filter-panel">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Time Range</label>
                            <select class="form-select bg-dark text-light" id="timeRange" onchange="loadAnomalies()">
                                <option value="1">Last Hour</option>
                                <option value="6">Last 6 Hours</option>
                                <option value="24" selected>Last 24 Hours</option>
                                <option value="168">Last Week</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Area Type</label>
                            <select class="form-select bg-dark text-light" id="areaType" onchange="loadAnomalies()">
                                <option value="">All Types</option>
                                <option value="military">Military</option>
                                <option value="nuclear">Nuclear</option>
                                <option value="airport">Airport</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Min Risk Score</label>
                            <input type="range" class="form-range" min="0" max="1" step="0.1" value="0" id="minRisk" onchange="document.getElementById('riskDisplay').textContent = this.value; loadAnomalies()">
                            <div class="text-center"><span id="riskDisplay">0.0</span></div>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-danger w-100" onclick="loadAnomalies()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h2 class="text-danger" id="totalAnomalies">-</h2>
                    <p class="mb-0">Total Anomalies</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h2 class="text-danger" id="highRisk">-</h2>
                    <p class="mb-0">High Risk</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h2 class="text-warning" id="mediumRisk">-</h2>
                    <p class="mb-0">Medium Risk</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h2 class="text-info" id="avgRisk">-</h2>
                    <p class="mb-0">Avg Risk Score</p>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="row">
            <div class="col-md-12">
                <h4><i class="fas fa-map-marked-alt"></i> Monitored Areas & Anomalies</h4>
                <div id="map"></div>
            </div>
        </div>

        <!-- Anomaly List -->
        <div class="row">
            <div class="col-md-12">
                <h4><i class="fas fa-exclamation-triangle"></i> Recent Anomalies</h4>
                <div id="anomalyList">
                    <div class="text-center p-4">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-3">Loading anomalies...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let markers = [];

        // Initialize map
        function initMap() {
            map = L.map('map').setView([51.5, 5.0], 7); // Center on Benelux

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                maxZoom: 19
            }).addTo(map);
        }

        async function loadAnomalies() {
            const hours = document.getElementById('timeRange').value;
            const areaType = document.getElementById('areaType').value;
            const minRisk = document.getElementById('minRisk').value;

            try {
                const params = new URLSearchParams({
                    hours: hours,
                    min_risk_score: minRisk,
                    ...(areaType && { area_type: areaType })
                });

                const response = await fetch(`/api/flights/anomalies?${params}`);
                const data = await response.json();

                // Update stats
                document.getElementById('totalAnomalies').textContent = data.stats.total;
                document.getElementById('highRisk').textContent = data.stats.by_risk_level.high;
                document.getElementById('mediumRisk').textContent = data.stats.by_risk_level.medium;
                document.getElementById('avgRisk').textContent = data.stats.avg_risk_score.toFixed(2);

                // Update map
                updateMap(data.anomalies);

                // Update list
                renderAnomalies(data.anomalies);

            } catch (error) {
                console.error('Error loading anomalies:', error);
                document.getElementById('anomalyList').innerHTML =
                    '<div class="alert alert-danger">Error loading anomalies. Check console.</div>';
            }
        }

        function updateMap(anomalies) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Group by area
            const areas = {};
            anomalies.forEach(a => {
                if (!areas[a.area_name]) {
                    areas[a.area_name] = {
                        lat: a.area_lat,
                        lon: a.area_lon,
                        type: a.area_type,
                        count: 0,
                        maxRisk: 0
                    };
                }
                areas[a.area_name].count++;
                areas[a.area_name].maxRisk = Math.max(areas[a.area_name].maxRisk, a.risk_score);
            });

            // Add markers
            Object.entries(areas).forEach(([name, area]) => {
                const color = area.maxRisk >= 0.7 ? 'red' : area.maxRisk >= 0.4 ? 'orange' : 'blue';

                const marker = L.circleMarker([area.lat, area.lon], {
                    radius: 8 + (area.count * 2),
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                }).addTo(map);

                marker.bindPopup(`
                    <strong>${name}</strong><br>
                    Type: ${area.type}<br>
                    Anomalies: ${area.count}<br>
                    Max Risk: ${area.maxRisk.toFixed(2)}
                `);

                markers.push(marker);
            });
        }

        function renderAnomalies(anomalies) {
            const container = document.getElementById('anomalyList');

            if (anomalies.length === 0) {
                container.innerHTML = '<div class="alert alert-success">No anomalies detected in selected time range.</div>';
                return;
            }

            container.innerHTML = anomalies.map(a => {
                const riskClass = a.risk_score >= 0.7 ? 'risk-high' : a.risk_score >= 0.4 ? 'risk-medium' : 'risk-low';
                const anomalyList = Array.isArray(a.anomalies) ? a.anomalies : JSON.parse(a.anomalies || '[]');

                return `
                    <div class="anomaly-card ${riskClass}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6>
                                    <i class="fas fa-plane"></i> ${a.callsign || 'Unknown'}
                                    <span class="badge badge-area-${a.area_type}">${a.area_type}</span>
                                </h6>
                                <small class="text-muted">${new Date(a.detection_time).toLocaleString()}</small>
                            </div>
                            <div class="text-end">
                                <strong class="text-danger">Risk: ${(a.risk_score * 100).toFixed(0)}%</strong>
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>Location:</strong> ${a.area_name}<br>
                            <strong>ICAO24:</strong> ${a.icao24}<br>
                            <strong>Altitude:</strong> ${a.altitude_m}m<br>
                            <strong>Velocity:</strong> ${a.velocity_kmh} km/h<br>
                            <strong>Origin:</strong> ${a.origin_country}
                        </div>
                        <div class="mt-2">
                            <strong>Anomalies Detected:</strong>
                            <ul class="mb-0 mt-1">
                                ${anomalyList.map(ano => `<li>${ano}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadAnomalies();

            // Auto-refresh every 60 seconds
            setInterval(loadAnomalies, 60000);
        });
    </script>
</body>
</html>
