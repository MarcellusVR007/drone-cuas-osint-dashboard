<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Forensics Demo - Post-Incident Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; }
        .recommendation { padding: 8px; margin: 4px 0; border-left: 3px solid; }
        .rec-critical { border-color: #dc3545; background: #fff5f5; }
        .rec-high { border-color: #ffc107; background: #fffef5; }
        .rec-medium { border-color: #0dcaf0; background: #f0fbff; }
        .rec-low { border-color: #6c757d; background: #f8f9fa; }
    </style>
</head>
<body>
    <div id="app" class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col">
                <h1>üîç Flight Forensics - Post-Incident Analysis</h1>
                <p class="text-muted">Analyze drone incidents using flight data, launch zone calculation, and maritime correlation</p>
            </div>
        </div>

        <!-- Incident Selector -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5>Select Incident to Analyze</h5>
                        <select v-model="selectedIncidentId" @change="analyzeIncident" class="form-select">
                            <option value="">-- Choose an incident --</option>
                            <option v-for="inc in incidents" :value="inc.id">
                                #{{inc.id}} - {{inc.title}} ({{inc.sighting_date}})
                            </option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div v-if="analysis" class="row">
            <!-- Incident Info -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìã Incident Details</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>ID:</strong> #{{analysis.incident.id}}</p>
                        <p><strong>Location:</strong> {{analysis.incident.latitude}}, {{analysis.incident.longitude}}</p>
                        <p><strong>Date:</strong> {{analysis.incident.sighting_date}}</p>
                        <p><strong>Drone:</strong> {{analysis.incident.drone_description || 'Unknown'}}</p>
                        <p><strong>Operator:</strong> {{analysis.incident.suspected_operator || 'Unknown'}}</p>
                    </div>
                </div>
            </div>

            <!-- Launch Zone -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üéØ Calculated Launch Zone</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Radius:</strong> {{analysis.launch_zone.radius_km}} km</p>
                        <p><strong>Center:</strong> {{analysis.launch_zone.center_lat.toFixed(4)}}, {{analysis.launch_zone.center_lon.toFixed(4)}}</p>
                        <p><strong>Drone Type:</strong> {{analysis.launch_zone.drone_type}}</p>
                        <p class="text-muted small">{{analysis.launch_zone.area_description}}</p>

                        <div v-if="analysis.maritime_correlation && analysis.maritime_correlation.length > 0" class="mt-3 alert alert-warning">
                            <strong>üö¢ Maritime Launch Suspected</strong>
                            <ul class="mb-0 mt-2">
                                <li v-for="m in analysis.maritime_correlation">
                                    {{m.area}}: {{m.note}} ({{m.priority}})
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flights Detected -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">‚úàÔ∏è Flights Detected</h5>
                    </div>
                    <div class="card-body">
                        <h3 class="text-center">{{analysis.flights_detected}}</h3>
                        <p class="text-center text-muted">flights in time window</p>
                        <p class="small" v-if="analysis.flights_detected === 0">
                            No historical flight data available (incident may be too old, or no flights in area)
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div v-if="analysis" class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üó∫Ô∏è Launch Zone Visualization</h5>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div v-if="analysis && analysis.recommendations" class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">üîç Investigation Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div v-for="rec in analysis.recommendations" :key="rec"
                             :class="getRecommendationClass(rec)"
                             class="recommendation">
                            {{rec}}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div v-if="loading" class="text-center my-5">
            <div class="spinner-border" role="status"></div>
            <p>Analyzing incident...</p>
        </div>
    </div>

    <script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                incidents: [],
                selectedIncidentId: '',
                analysis: null,
                loading: false,
                map: null
            }
        },
        mounted() {
            this.loadIncidents();
        },
        methods: {
            async loadIncidents() {
                const res = await fetch('/api/incidents/?limit=100');
                const data = await res.json();
                this.incidents = data.incidents;
            },
            async analyzeIncident() {
                if (!this.selectedIncidentId) return;

                this.loading = true;
                this.analysis = null;

                try {
                    const res = await fetch(`/api/flight-forensics/incident/${this.selectedIncidentId}`);
                    this.analysis = await res.json();

                    this.$nextTick(() => {
                        this.renderMap();
                    });
                } catch (e) {
                    alert('Error analyzing incident: ' + e);
                } finally {
                    this.loading = false;
                }
            },
            renderMap() {
                if (this.map) {
                    this.map.remove();
                }

                const lz = this.analysis.launch_zone;

                // Skip map rendering for incidents with unknown coordinates (0,0 = Null Island)
                if (lz.center_lat === 0.0 && lz.center_lon === 0.0) {
                    return;
                }

                this.map = L.map('map').setView([lz.center_lat, lz.center_lon], 8);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(this.map);

                // Incident marker
                L.marker([this.analysis.incident.latitude, this.analysis.incident.longitude])
                    .addTo(this.map)
                    .bindPopup(`<b>Incident Location</b><br>${this.analysis.incident.title}`)
                    .openPopup();

                // Launch zone circle
                L.circle([lz.center_lat, lz.center_lon], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.1,
                    radius: lz.radius_km * 1000
                }).addTo(this.map).bindPopup(`<b>Possible Launch Zone</b><br>Radius: ${lz.radius_km}km`);
            },
            getRecommendationClass(rec) {
                if (rec.includes('üî¥')) return 'rec-critical';
                if (rec.includes('üü°')) return 'rec-high';
                if (rec.includes('üîµ')) return 'rec-medium';
                return 'rec-low';
            }
        }
    }).mount('#app');
    </script>
</body>
</html>
