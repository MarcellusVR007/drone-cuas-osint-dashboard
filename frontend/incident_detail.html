<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactical Intelligence Report</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet Maps -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
            --info: #17a2b8;
            --dark: #343a40;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            color: #ffffff;
            margin-bottom: 1.5rem;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.2);
            transition: all 0.3s ease;
        }

        .severity-HIGH {
            border-left: 5px solid #dc3545;
        }

        .severity-MEDIUM {
            border-left: 5px solid #ffc107;
        }

        .severity-LOW {
            border-left: 5px solid #28a745;
        }

        #map {
            height: 400px;
            border-radius: 10px;
            border: 2px solid rgba(220, 53, 69, 0.3);
        }

        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badge-custom {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        h1, h2, h3, h4, h5, h6, p, span, div, label {
            color: #ffffff !important;
        }

        .threat-meter {
            height: 30px;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            border-radius: 15px;
            position: relative;
            margin: 1rem 0;
        }

        .threat-indicator {
            position: absolute;
            top: -5px;
            width: 4px;
            height: 40px;
            background: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
            border-radius: 2px;
        }

        .attribution-bar {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .attribution-segment {
            height: 100%;
            float: left;
            transition: all 0.3s ease;
        }

        .related-incident {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .related-incident:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(220, 53, 69, 0.5);
        }

        .source-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .loading-spinner {
            text-align: center;
            padding: 3rem;
        }

        .assessment-content {
            line-height: 1.8;
        }

        .assessment-content h1,
        .assessment-content h2,
        .assessment-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .assessment-content ul {
            padding-left: 1.5rem;
        }

        .metadata-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metadata-label {
            font-weight: 600;
            opacity: 0.7;
            min-width: 150px;
            display: inline-block;
        }

        .confidence-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Back Button -->
        <a href="index.html" class="btn btn-outline-light back-btn">
            <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
        </a>

        <div class="container-fluid mt-5 pt-4">
            <!-- Loading State -->
            <div v-if="loading" class="loading-spinner">
                <div class="spinner-border text-danger" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading tactical intelligence...</p>
            </div>

            <!-- Main Content -->
            <div v-else>
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h1 class="display-5 mb-2">
                                    <i class="fas fa-satellite-dish text-danger me-3"></i>
                                    {{ incident.title }}
                                </h1>
                                <p class="text-muted mb-3">
                                    <i class="fas fa-calendar me-2"></i>{{ incident.sighting_date }} {{ incident.sighting_time }}
                                    <span class="mx-3">|</span>
                                    <i class="fas fa-map-marker-alt me-2"></i>{{ restrictedArea?.name || 'Unknown Location' }}
                                </p>
                            </div>
                            <button
                                @click="markAsFalsePositive"
                                class="btn btn-outline-warning"
                                title="Mark this as not a real incident (hides from database)"
                                style="white-space: nowrap;">
                                <i class="fas fa-times-circle me-2"></i>Mark False Positive
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tactical Assessment Card -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card" :class="'severity-' + (assessment.severity || 'LOW')">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-shield-alt text-danger me-2"></i>
                                    Tactical Assessment
                                </h3>

                                <!-- Severity & Threat Level -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-label">Severity</div>
                                            <div class="stat-number">
                                                <span :class="'badge badge-' + getSeverityClass(assessment.severity)">
                                                    {{ assessment.severity || 'UNKNOWN' }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-label">Threat Level</div>
                                            <div class="stat-number text-danger">
                                                {{ assessment.threat_level || '?' }}/10
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Threat Meter -->
                                <div class="mb-4">
                                    <label class="form-label">Threat Visualization</label>
                                    <div class="threat-meter">
                                        <div class="threat-indicator" :style="{left: (assessment.threat_level || 0) * 10 + '%'}"></div>
                                    </div>
                                </div>

                                <!-- Assessment Text -->
                                <div v-if="assessment.assessment_text" class="assessment-content mb-4">
                                    <h5>Intelligence Analysis</h5>
                                    <div v-html="renderMarkdown(assessment.assessment_text)"></div>
                                </div>

                                <!-- Pattern Match -->
                                <div v-if="assessment.pattern_match" class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Pattern Detected:</strong> {{ assessment.pattern_match }}
                                </div>

                                <!-- Recommended Actions -->
                                <div v-if="assessment.recommended_actions && assessment.recommended_actions.length" class="mb-4">
                                    <h5><i class="fas fa-tasks me-2"></i>Recommended Actions</h5>
                                    <ul>
                                        <li v-for="action in assessment.recommended_actions" :key="action">
                                            {{ action }}
                                        </li>
                                    </ul>
                                </div>

                                <!-- Attribution Analysis -->
                                <div v-if="assessment.attribution_likelihood" class="mb-4">
                                    <h5><i class="fas fa-user-secret me-2"></i>Attribution Likelihood</h5>
                                    <div v-for="(prob, actor) in assessment.attribution_likelihood" :key="actor" class="mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>{{ formatActorName(actor) }}</span>
                                            <span>{{ (prob * 100).toFixed(0) }}%</span>
                                        </div>
                                        <div class="attribution-bar">
                                            <div class="attribution-segment"
                                                 :style="{width: (prob * 100) + '%', background: getActorColor(actor)}">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Intelligence Gaps -->
                                <div v-if="assessment.intelligence_gaps && assessment.intelligence_gaps.length" class="mb-4">
                                    <h5><i class="fas fa-question-circle me-2"></i>Intelligence Gaps</h5>
                                    <ul>
                                        <li v-for="gap in assessment.intelligence_gaps" :key="gap" class="text-warning">
                                            {{ gap }}
                                        </li>
                                    </ul>
                                </div>

                                <!-- Confidence Score -->
                                <div class="text-end">
                                    <span class="me-2">Assessment Confidence:</span>
                                    <span class="confidence-badge" :class="getConfidenceClass(assessment.confidence)">
                                        {{ (assessment.confidence * 100).toFixed(0) }}%
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Incident Details Card -->
                        <div class="card">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-info-circle text-info me-2"></i>
                                    Incident Details
                                </h3>

                                <div class="metadata-item">
                                    <span class="metadata-label">Description:</span>
                                    <span>{{ incident.description || 'No description available' }}</span>
                                </div>

                                <div class="metadata-item">
                                    <span class="metadata-label">Location:</span>
                                    <span>{{ incident.latitude?.toFixed(4) }}, {{ incident.longitude?.toFixed(4) }}</span>
                                </div>

                                <div class="metadata-item" v-if="incident.altitude_m">
                                    <span class="metadata-label">Altitude:</span>
                                    <span>{{ incident.altitude_m }} meters</span>
                                </div>

                                <div class="metadata-item" v-if="incident.duration_minutes">
                                    <span class="metadata-label">Duration:</span>
                                    <span>{{ incident.duration_minutes }} minutes</span>
                                </div>

                                <div class="metadata-item" v-if="incident.drone_description">
                                    <span class="metadata-label">Drone Type:</span>
                                    <span>{{ incident.drone_description }}</span>
                                </div>

                                <div class="metadata-item">
                                    <span class="metadata-label">Source:</span>
                                    <span>{{ incident.display_source || incident.source }}</span>
                                </div>

                                <div class="metadata-item" v-if="incident.source_url">
                                    <span class="metadata-label">Source URL:</span>
                                    <a :href="incident.source_url" target="_blank" class="text-info">
                                        View Original <i class="fas fa-external-link-alt ms-1"></i>
                                    </a>
                                </div>

                                <div class="metadata-item">
                                    <span class="metadata-label">Confidence Score:</span>
                                    <span>{{ (incident.confidence_score * 100).toFixed(0) }}%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Map -->
                        <div class="card">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-map text-success me-2"></i>
                                    Location Map
                                </h3>
                                <div id="map"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <!-- Related Incidents -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-link text-warning me-2"></i>
                                    Related Incidents ({{ relatedIncidents.length }})
                                </h5>

                                <div v-if="relatedIncidents.length === 0" class="text-muted text-center py-3">
                                    No related incidents found
                                </div>

                                <div v-else>
                                    <div v-for="related in relatedIncidents"
                                         :key="related.id"
                                         class="related-incident"
                                         @click="goToIncident(related.id)">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <strong>{{ related.title }}</strong>
                                            <span class="badge badge-secondary ms-2">
                                                {{ related.days_apart }}d ago
                                            </span>
                                        </div>
                                        <div class="small text-muted">
                                            <i class="fas fa-calendar me-1"></i>{{ related.sighting_date }}
                                        </div>
                                        <div class="small text-muted" v-if="related.distance_km">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ related.distance_km }} km away
                                        </div>
                                        <div class="small mt-2" style="opacity: 0.8;">
                                            {{ truncate(related.description, 100) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Multi-Source Intelligence -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-newspaper text-primary me-2"></i>
                                    Source Intelligence
                                </h5>

                                <div v-if="sources.length === 0" class="text-muted text-center py-3">
                                    No additional sources available
                                </div>

                                <div v-else>
                                    <div v-for="source in sources" :key="source.id" class="source-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <span class="badge badge-info">{{ source.source_type }}</span>
                                            <span class="small text-muted">{{ source.pub_date }}</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>{{ source.title }}</strong>
                                        </div>
                                        <div class="small mb-2" style="opacity: 0.9;">
                                            {{ truncate(source.summary, 150) }}
                                        </div>
                                        <a v-if="source.url" :href="source.url" target="_blank" class="btn btn-sm btn-outline-primary">
                                            Read Full Article <i class="fas fa-external-link-alt ms-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Target Information -->
                        <div v-if="restrictedArea" class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-crosshairs text-danger me-2"></i>
                                    Target Information
                                </h5>

                                <div class="metadata-item">
                                    <span class="metadata-label">Area Name:</span>
                                    <span>{{ restrictedArea.name }}</span>
                                </div>

                                <div class="metadata-item">
                                    <span class="metadata-label">Type:</span>
                                    <span>{{ formatAreaType(restrictedArea.area_type) }}</span>
                                </div>

                                <div class="metadata-item">
                                    <span class="metadata-label">Country:</span>
                                    <span>{{ restrictedArea.country }}</span>
                                </div>

                                <div class="metadata-item">
                                    <span class="metadata-label">Threat Level:</span>
                                    <span class="text-danger">{{ restrictedArea.threat_level }}/10</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    incidentId: null,
                    incident: {},
                    restrictedArea: null,
                    assessment: {},
                    relatedIncidents: [],
                    sources: [],
                    map: null
                }
            },
            mounted() {
                // Get incident ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                this.incidentId = urlParams.get('id');

                if (this.incidentId) {
                    this.loadData();
                }
            },
            methods: {
                async loadData() {
                    this.loading = true;

                    try {
                        // Load incident details
                        const incidentResp = await fetch(`/api/incidents/${this.incidentId}`);
                        this.incident = await incidentResp.json();

                        // Load restricted area if available
                        if (this.incident.restricted_area_id) {
                            const areaResp = await fetch(`/api/restricted-areas/${this.incident.restricted_area_id}`);
                            this.restrictedArea = await areaResp.json();
                        }

                        // Load tactical assessment
                        const assessmentResp = await fetch(`/api/incidents/${this.incidentId}/tactical-assessment`);
                        this.assessment = await assessmentResp.json();

                        // Load related incidents
                        const relatedResp = await fetch(`/api/incidents/${this.incidentId}/related`);
                        this.relatedIncidents = await relatedResp.json();

                        // Load sources
                        const sourcesResp = await fetch(`/api/incidents/${this.incidentId}/sources`);
                        this.sources = await sourcesResp.json();

                        // Initialize map
                        this.$nextTick(() => {
                            this.initMap();
                        });
                    } catch (error) {
                        console.error('Error loading data:', error);
                        alert('Failed to load incident data');
                    } finally {
                        this.loading = false;
                    }
                },
                async markAsFalsePositive() {
                    if (!confirm('Are you sure you want to mark this as a FALSE POSITIVE?\n\nThis will hide it from all incident views and dashboards.')) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/incidents/${this.incidentId}/mark-false-positive`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert(`✅ Incident marked as FALSE POSITIVE\n\n${result.message}\n\nRedirecting to homepage...`);
                            window.location.href = '/';
                        } else {
                            throw new Error('Failed to mark as false positive');
                        }
                    } catch (error) {
                        console.error('Error marking false positive:', error);
                        alert('❌ Failed to mark incident as false positive');
                    }
                },
                initMap() {
                    if (this.map) {
                        this.map.remove();
                    }

                    // Validate coordinates
                    const lat = parseFloat(this.incident.latitude);
                    const lon = parseFloat(this.incident.longitude);

                    // Check if coordinates are valid
                    if (!lat || !lon || isNaN(lat) || isNaN(lon)) {
                        console.error('Invalid coordinates:', lat, lon);
                        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ffc107;"><i class="fas fa-exclamation-triangle me-2"></i>Location data not available</div>';
                        return;
                    }

                    try {
                        this.map = L.map('map').setView([lat, lon], 13);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors',
                            maxZoom: 19
                        }).addTo(this.map);

                        // Add incident marker
                        const incidentIcon = L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background: #dc3545; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                            iconSize: [20, 20]
                        });

                        L.marker([lat, lon], { icon: incidentIcon })
                            .addTo(this.map)
                            .bindPopup(`<b>${this.incident.title}</b><br>${this.incident.sighting_date}`);

                        // Add related incidents
                        this.relatedIncidents.forEach(related => {
                            if (related.latitude && related.longitude) {
                                const relatedIcon = L.divIcon({
                                    className: 'custom-marker',
                                    html: '<div style="background: #ffc107; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>',
                                    iconSize: [15, 15]
                                });

                                L.marker([related.latitude, related.longitude], { icon: relatedIcon })
                                    .addTo(this.map)
                                    .bindPopup(`<b>${related.title}</b><br>${related.sighting_date}`);
                            }
                        });

                        // Force map refresh after a short delay
                        setTimeout(() => {
                            if (this.map) {
                                this.map.invalidateSize();
                            }
                        }, 100);
                    } catch (error) {
                        console.error('Error initializing map:', error);
                        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc3545;"><i class="fas fa-exclamation-circle me-2"></i>Error loading map</div>';
                    }
                },
                renderMarkdown(text) {
                    if (!text) return '';
                    return marked.parse(text);
                },
                getSeverityClass(severity) {
                    const map = {
                        'HIGH': 'danger',
                        'MEDIUM': 'warning',
                        'LOW': 'success'
                    };
                    return map[severity] || 'secondary';
                },
                formatActorName(actor) {
                    return actor.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                },
                getActorColor(actor) {
                    const colors = {
                        'state_actor': '#dc3545',
                        'criminal': '#fd7e14',
                        'hobbyist': '#28a745',
                        'activist': '#17a2b8'
                    };
                    return colors[actor] || '#6c757d';
                },
                getConfidenceClass(confidence) {
                    if (confidence >= 0.7) return 'bg-success';
                    if (confidence >= 0.4) return 'bg-warning';
                    return 'bg-danger';
                },
                formatAreaType(type) {
                    if (!type) return 'Unknown';
                    return type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                },
                truncate(text, maxLength) {
                    if (!text) return '';
                    if (text.length <= maxLength) return text;
                    return text.substr(0, maxLength) + '...';
                },
                goToIncident(id) {
                    window.location.href = `incident_detail.html?id=${id}`;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
